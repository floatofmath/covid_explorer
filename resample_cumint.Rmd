---
title: "COVID Survival"
author: "DI Dr. Florian Klinglmueller"
date: "4/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source('R/setup.R')
library(survival)
library(cmprsk)
library(gridExtra)
```

# Estimating a competing risk model for recovery/death from COVID-19

**This is work very much in process**

## Introduction

Estimating the mortality rate of COVID-19 is a challenge for mainly two reasons: incomplete reporting and incomplete follow-up. While current best attempts to solve the former use a combination of information from complete cases like data from the Diamond Princess. Here I attempt to adress the latter problem by reconstruction of possible time-to-event data using resampling techniques. This permits the estimation cause-specific cumulative incidence rates. Which we can then use to estimate e.g. the 30 day survival rate, while handling censored data in a principled manner.

In order to estimate the cumulative incidence of mortality or recovery after infection, we would require individual level time-to-event data. That is, data on the time from the start of infection to either recovery, death, or censoring for each subject. Unfortunately we neither have the date of infection, nor individual level data. While the latter is realistically never available as time of infection is typically unknown, individual level data could be available available if data gathering is sufficiently detailed. However, in practice individual level data are not be available except for special cases, much less publicly.

Consequently, important disease characterstics have to be estimated from aggregate data. Which typically ignores the information available from the sequence of events. Obviously, we know that the event of a newly recorded case can only lie in the future and that save for reporting errors each event corresponds to a case detected in the past. Consequently, we can attempt to randomly connect confirmed events with cases detected in the past and construct a random dataset of individual time to event data that at least does not violate restrictions imposed by the sequence of reported events.

We can then use standard methods from competing risks models to estimate the cumulative incidence curves for mortality and recovery. 

For the time being I only generate a single random time to event dataset for each country and use that to estimate cumulative incidence curves. Ideally, one would generate several "random" dataset to quantify the possible range of different estimates. Also currently, I sampling is such that each event is matched a case in the past with equal probablity. This can be improved by applying sampling weights from a survival distributions. However, that makes the process quite a bit slower and results do not differ substantially, so for the moment I use uniform sampling weights.

Interestingly it does not appear that there is a large variability between different realizations of randomly generated time to event datasets. That even extends to datasets generated using weighted resampling, i.e. where the propability of connecting an recent event to a past confirmed case is a function of the time difference (e.g. exponential distribution).

What I do see is that such estimated mortality rates but also recovery rates typically far exceed naive estimators that divide the number of deaths or recovered by the number of cases. This is because the model assumes that unresolved cases have similar mortality/recovery rates as resolved cases. However, compared to aggregate rate estimates that divide by the number of resolved cases, mortality and recovery rates obtained from models are typically smaller.

## Future Improvements

While estimates are not substantially variable across samples, things do vary. E.g. for Austria I get limit mortality rates about between 3% and 4%. Also the curves often vary at the end, were the (artificial) number at risk gets small. So it would certainy be interesting to resample a couple of datasets an take an average and also quantify the variability. 

Weighted sampling would definitely be interesting. Currently for a given event, all cases in the past, that have not yet been allocated are equally likely selected. Actually, given that the number of new cases per day increases (typically) it is more probably that a case closer to the event is chosen compared to one further away. I have already implemented weighting function, but it increases computation time and I have not yet determined a plausible weighting function. Exponential weighting, does not lead to substantial changes in the results.

For countries with regional data available one could further restrict within region. This would in theory be even closer to reality. However, from experience in Austria I assume that also data quality would decline as regional reporting practices may differ and be more error prone than national aggregates. 

## Results

We start with China and South Korea which have only few unresolved cases.


```{r cumulative incidence}


data_long %>% estimate_surv('China') -> cumint_china 
plot_cuminc(cumint_china) + ggtitle('China') -> plot_cumint_china

data_long %>% estimate_surv('Republic of Korea') -> cumint_korea
#cumint_korea %>% group_by(Event) %>% arrange(time) %>% slice(n()-1)
est_cumint <- function(cumint) group_by(cumint,Event) %>% arrange(time) %>% slice(n()-1)

plot_cuminc(cumint_korea) + ggtitle('Korea') -> plot_cumint_korea

grid.arrange(plot_cumint_china,plot_cumint_korea,nrow=1)

```
As China was the country first affected by COVID-19 it has the longest follow-up and the largest proportion of resolved cases. Similarly South Korea was hit early and has since a large proportion of resolved cases. In China about 75% of subjects recovered 30 days following detection. In South Korea this proportion is slightly lower. However, ultimately we are interested in the limit of recovery and mortality. For China the last estimate on the curve is about 96% recoverd at day 72 and 4% deceased at Day 65. For Korea it is about 90% recovered at Day 60 and 2% deceased at Day 38. 

## Europe

Next we move to Europe where we look at Austria, Sweden, Germany and Italy:


```{r cumulative incidence Europe}
cumint_austria <-  data_long %>% estimate_surv('Austria') 
#est_cumint(cumint_austria)
plot_cuminc(cumint_austria) + ggtitle('Austria') -> plot_cumint_austria

cumint_sweden <- estimate_surv(data_long,'Sweden') 
plot_cuminc(cumint_sweden) + ggtitle('Sweden') -> plot_cumint_sweden

cumint_germany <- estimate_surv(data_long,'Germany')
#est_cumint(cumint_germany)
plot_cuminc(cumint_germany) + ggtitle('Germany') -> plot_cumint_germany

cumint_italy <- estimate_surv(data_long,'Italy')
plot_cuminc(cumint_italy) + ggtitle('Italy') -> plot_cumint_italy

grid.arrange(plot_cumint_austria,plot_cumint_sweden,
             plot_cumint_germany,plot_cumint_italy,ncol=2)


```

While Austria and Germany appear quite similar to South Korea. Italy and Sweden show quite different results. Italy has a substantially higher mortality rate than then the other countries in this comparison. After 40 days about 25% of cases die, whereas only about 38% of subjects are recovered. *This may be due to specifics of the testing practice with only hospitalized subjects tested (based on hearsay need source)*. Sweden which also follows a different strategy, also appears to have a high mortality rate with about 18% deceased 30 days after detection, and only about 8% recovered after about the same amount of time. Clearly there has to be some explanation in the way Sweden tests cases and determines recovery. 

For Austria I estimate about 4% deceased after 30 days and about 70% recovered after about the same amount of time. For Germany we obtain an estimate around 4% after about a month and a recovery rate of about 96% after about 2 months. This is probably because Germany had a few very early cases, and can be seen also in the long horizontal segment in the recovery curve between about 30 and 50 days.
